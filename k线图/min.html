<!-- 分时接口
https://quotes.sina.cn/cn/api/openapi.php/CN_MinlineService.getMinlineData?symbol=sh515220&callback=var%20t1sh515220=&dpc=1 -->
<!-- 代码来源https://www.codeleading.com/article/80265708464/ -->

<!DOCTYPE html>
<html lang="en">
<script type="text/javascript" src="https://js.jrjimg.cn/lib/jquery-1.7.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/echarts/4.7.0/echarts.min.js"></script>
<div class="container">

    <caption class="caption">
        <h5>动态分时图</h5>
    </caption>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="width: 80%;height:400px;border: darkblue solid 1px;"></div>
</div>
<script>

    function randomData() {
        now = new Date(+now + oneDay);
        value = value + Math.random() * 21 - 10;
        return {
            name: now.toString(),
            value: [
                [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/'),
                Math.round(value)
            ]
        }
    }
    function randomData_source() {
        now = new Date(+now + oneDay);
        value = value + Math.random() * 21 - 10;
        return {
            name: now.toString(),
            value: [
                [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/'),
                Math.round(value)
            ]
        }
    }

    var data = [];
    var now = +new Date(2022, 8, 25);
    var oneDay = 24 * 3600 * 1000;
    var value = Math.random() * 10;
    for (var i = 0; i < 50; i++) {
        // console.log(randomData().value.toString())
        // _p = {name: "1877/2/2" + i, value: i};
        // console.log(_p)
        // data.push(_p);
        data.push(randomData());
    }


    // var _minVal = Number(baseNumber-baseNumberhandle_num()).toFixed(2);
    // var _maxVal = (Number(baseNumber)+baseNumberhandle_num()).toFixed(2);

    option = {
        title: {
            text: '动态数据 + 时间坐标轴'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function (params) {
                console.log(params)
                params = params[0];

                var date = new Date(params.name);
                return date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' : ' + params.value[1];
            },
            axisPointer: {
                animation: false
            }
        },
        xAxis: {
            type: 'time',
            splitLine: {
                show: false
            }
        },
        // yAxis: {
        //     type: 'value',
        //     boundaryGap: [0, '100%'],
        //     splitLine: {
        //         show: false
        //     }
        // },
        yAxis: [ //y轴
            {
                type: 'value',
                min: 20,
                max: 10,
                interval: 5,
                gridIndex: 0,
                scale: true,
                axisTick: { // 分割线 短
                    show: false
                },
                axisLine: {
                    lineStyle: {
                        color: '000000',
                    }
                },
                axisPointer: {
                    show: true,
                    label: {
                        formatter: function (params) {
                            return (params.value).toFixed(2);
                        }
                    }
                },
                axisLabel: {
                    color: '#333',
                    formatter: format_y,
                    rich: {
                        red: {
                            color: 'red',
                            lineHeight: 10
                        },
                        green: {
                            color: 'green',
                            lineHeight: 10
                        }
                    }
                },
                z: 4,
                splitLine: { //分割线设置
                    show: true,
                    lineStyle: {
                        type: 'dashed'
                    }
                },
            }, {
                scale: true,
                gridIndex: 1,
                min: _minVal,
                max: _maxVal,
                interval: _interval,
                position: 'right',
                z: 4,
                axisTick: {
                    show: false
                },
                axisLine: {
                    lineStyle: {
                        color: borderColor,
                    }
                },
                axisLabel: { //label文字设置
                    color: function (val) {
                        val = Number(val).toFixed(2)
                        if (val == baseNumber) {
                            return '#333'
                        }
                        return val > baseNumber ? upColor : downColor;
                    },
                    formatter: function (val) {
                        var resul = ratioCalculate(val, baseNumber);
                        return Number(resul).toFixed(2) + '%'
                    }
                },
                splitLine: { //分割线设置
                    show: false,
                    lineStyle: {
                        color: '#181a23'
                    }
                },
                axisPointer: {
                    show: true,
                    label: {
                        formatter: function (params) { //计算右边Y轴对应的当前价的涨幅比例
                            return ratioCalculate(params.value, baseNumber) + '%';
                        }
                    }
                }
            }, {// 成交量的y轴配置
                //...已省略
            }
        ],

        series: [{
            name: '模拟数据',
            type: 'line',
            showSymbol: false,
            hoverAnimation: false,
            data: data
        }]
    };

    var myChart = echarts.init(document.getElementById('main'));
    function getAPI() {
        var api_url = 'http://127.0.0.1:3004/getMinite_KLine?code=300056';
        $.get(api_url, function (result) {
            // data = [];
            let dataArr = result.data;
            for (var i = 0; i < dataArr.length; i++) {
                _p = { name: dataArr[i].m, value: dataArr[i].p };
                // console.log(_p)
                // data.push(_p);
            }
            myChart.setOption(option);
        });
    }
    getAPI();

    //轮询获取数据
    setInterval(function () {
        // for (var i = 0; i < 5; i++) {
        //     data.shift();
        //     data.push(randomData());
        // }
        myChart.setOption({
            series: [{
                data: data
            }]
        });
    }, 1000);
</script>
</body>

</html>